name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  FLASK_APP: app.py

jobs:
  # Job 1: Install Dependencies and Run Tests
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
        continue-on-error: true
      
      - name: Run Tests with pytest
        run: |
          pytest test_app.py -v --junitxml=test-results.xml --cov=app --cov-report=xml --cov-report=html
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
      
      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: Display Coverage Report
        run: |
          echo "Coverage report generated successfully!"
          if [ -f coverage.xml ]; then
            echo "Coverage XML file found"
          fi

  # Job 2: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Safety Check
        run: |
          pip install safety
          safety check --json || true
        continue-on-error: true
      
      - name: Run Bandit Security Scan
        run: |
          pip install bandit
          bandit -r app.py -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json

  # Job 3: Build Application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create Build Artifact
        run: |
          mkdir -p build
          cp app.py build/
          cp requirements.txt build/
          tar -czf flask-app-${{ github.sha }}.tar.gz build/
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flask-app-artifact
          path: flask-app-${{ github.sha }}.tar.gz
          retention-days: 30

  # Job 4: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: flask-app-artifact
      
      - name: Display Artifact
        run: |
          ls -lah
          echo "Build artifact downloaded successfully!"
      
      - name: Deploy to Staging Server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PATH: ${{ secrets.STAGING_DEPLOY_PATH }}
        run: |
          echo "Deploying to staging environment..."
          # Example deployment commands (customize based on your infrastructure)
          # mkdir -p ~/.ssh
          # echo "$STAGING_KEY" > ~/.ssh/deploy_key
          # chmod 600 ~/.ssh/deploy_key
          # scp -i ~/.ssh/deploy_key flask-app-${{ github.sha }}.tar.gz $STAGING_USER@$STAGING_HOST:$STAGING_PATH
          # ssh -i ~/.ssh/deploy_key $STAGING_USER@$STAGING_HOST "cd $STAGING_PATH && tar -xzf flask-app-${{ github.sha }}.tar.gz"
          # ssh -i ~/.ssh/deploy_key $STAGING_USER@$STAGING_HOST "cd $STAGING_PATH/build && pip install -r requirements.txt"
          # ssh -i ~/.ssh/deploy_key $STAGING_USER@$STAGING_HOST "sudo systemctl restart flask-app-staging"
          echo "Deployment to staging completed!"
      
      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests on staging..."
          # Example: curl -f https://staging.example.com/api/health || exit 1
          echo "Smoke tests passed!"
      
      - name: Notify Deployment Success
        if: success()
        run: |
          echo "Staging deployment successful!"
          echo "Staging URL: https://staging.example.com"

  # Job 5: Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://production.example.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: flask-app-artifact
      
      - name: Display Artifact
        run: |
          ls -lah
          echo "Build artifact downloaded successfully!"
      
      - name: Deploy to Production Server
        env:
          PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
          PRODUCTION_USER: ${{ secrets.PRODUCTION_USER }}
          PRODUCTION_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
          PRODUCTION_PATH: ${{ secrets.PRODUCTION_DEPLOY_PATH }}
        run: |
          echo "Deploying to production environment..."
          # Example deployment commands (customize based on your infrastructure)
          # mkdir -p ~/.ssh
          # echo "$PRODUCTION_KEY" > ~/.ssh/deploy_key
          # chmod 600 ~/.ssh/deploy_key
          # scp -i ~/.ssh/deploy_key flask-app-${{ github.sha }}.tar.gz $PRODUCTION_USER@$PRODUCTION_HOST:$PRODUCTION_PATH
          # ssh -i ~/.ssh/deploy_key $PRODUCTION_USER@$PRODUCTION_HOST "cd $PRODUCTION_PATH && tar -xzf flask-app-${{ github.sha }}.tar.gz"
          # ssh -i ~/.ssh/deploy_key $PRODUCTION_USER@$PRODUCTION_HOST "cd $PRODUCTION_PATH/build && pip install -r requirements.txt"
          # ssh -i ~/.ssh/deploy_key $PRODUCTION_USER@$PRODUCTION_HOST "sudo systemctl restart flask-app"
          echo "Deployment to production completed!"
      
      - name: Run Production Health Check
        run: |
          echo "Running health check on production..."
          # Example: curl -f https://production.example.com/api/health || exit 1
          echo "Production health check passed!"
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## Changes in this Release
            - Deployed to production
            - Build artifact: flask-app-${{ github.sha }}.tar.gz
          draft: false
          prerelease: false
      
      - name: Notify Deployment Success
        if: success()
        run: |
          echo "Production deployment successful!"
          echo "Production URL: https://production.example.com"

  # Job 6: Notify on Failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, security, build, deploy-staging, deploy-production]
    if: failure()
    
    steps:
      - name: Send Failure Notification
        run: |
          echo "Pipeline failed! Check the logs for details."
          # Add notification logic here (e.g., Slack, email, etc.)
